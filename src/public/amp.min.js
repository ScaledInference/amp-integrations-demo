var Amp=function(){"use strict";var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};var t="undefined"!=typeof window?window:void 0!==e?e:"undefined"!=typeof self?self:{},n=function(e){var t=r.call(e);return"[object Function]"===t||"function"==typeof e&&"[object RegExp]"!==t||"undefined"!=typeof window&&(e===window.setTimeout||e===window.alert||e===window.confirm||e===window.prompt)},r=Object.prototype.toString;var i,o=(function(e,t){(t=e.exports=function(e){return e.replace(/^\s*|\s*$/g,"")}).left=function(e){return e.replace(/^\s*/,"")},t.right=function(e){return e.replace(/\s*$/,"")}}(i={exports:{}},i.exports),i.exports),a=function(e,t,r){if(!n(t))throw new TypeError("iterator must be a function");3>arguments.length&&(r=this);"[object Array]"===s.call(e)?function(e,t,n){for(var r=0,i=e.length;i>r;r++)u.call(e,r)&&t.call(n,e[r],r,e)}(e,t,r):"string"==typeof e?function(e,t,n){for(var r=0,i=e.length;i>r;r++)t.call(n,e.charAt(r),r,e)}(e,t,r):function(e,t,n){for(var r in e)u.call(e,r)&&t.call(n,e[r],r,e)}(e,t,r)},s=Object.prototype.toString,u=Object.prototype.hasOwnProperty;var c=function(e){if(!e)return{};var t={};return a(o(e).split("\n"),function(e){var n=e.indexOf(":"),r=o(e.slice(0,n)).toLowerCase(),i=o(e.slice(n+1));void 0===t[r]?t[r]=i:"[object Array]"===Object.prototype.toString.call(t[r])?t[r].push(i):t[r]=[t[r],i]}),t},l=function(){for(var e={},t=0;arguments.length>t;t++){var n=arguments[t];for(var r in n)d.call(n,r)&&(e[r]=n[r])}return e},d=Object.prototype.hasOwnProperty;var f=h;function p(e,t,r){var i=e;return n(t)?(r=t,"string"==typeof e&&(i={uri:e})):i=l(t,{uri:e}),i.callback=r,i}function h(e,t,n){return y(t=p(e,t,n))}function y(e){if(void 0===e.callback)throw Error("callback argument missing");var t=!1,n=function(n,r,i){t||(t=!0,e.callback(n,r,i))};function r(e){return clearTimeout(u),e instanceof Error||(e=Error(""+(e||"Unknown XMLHttpRequest Error"))),e.statusCode=0,n(e,v)}function i(){if(!a){var t;clearTimeout(u);var r=v,i=null;return 0!==(t=e.useXDR&&void 0===s.status?200:1223===s.status?204:s.status)?(r={body:function(){var e=void 0;if(e=s.response?s.response:s.responseText||function(e){try{if("document"===e.responseType)return e.responseXML;var t=e.responseXML&&"parsererror"===e.responseXML.documentElement.nodeName;if(""===e.responseType&&!t)return e.responseXML}catch(e){}return null}(s),m)try{e=JSON.parse(e)}catch(e){}return e}(),statusCode:t,method:d,headers:{},url:l,rawRequest:s},s.getAllResponseHeaders&&(r.headers=c(s.getAllResponseHeaders()))):i=Error("Internal XMLHttpRequest Error"),n(i,r,r.body)}}var o,a,s=e.xhr||null;s||(s=e.cors||e.useXDR?new h.XDomainRequest:new h.XMLHttpRequest);var u,l=s.url=e.uri||e.url,d=s.method=e.method||"GET",f=e.body||e.data,p=s.headers=e.headers||{},y=!!e.sync,m=!1,v={body:void 0,headers:{},statusCode:0,method:d,url:l,rawRequest:s};if("json"in e&&!1!==e.json&&(m=!0,p.accept||p.Accept||(p.Accept="application/json"),"GET"!==d&&"HEAD"!==d&&(p["content-type"]||p["Content-Type"]||(p["Content-Type"]="application/json"),f=JSON.stringify(!0===e.json?f:e.json))),s.onreadystatechange=function(){4===s.readyState&&setTimeout(i,0)},s.onload=i,s.onerror=r,s.onprogress=function(){},s.onabort=function(){a=!0},s.ontimeout=r,s.open(d,l,!y,e.username,e.password),y||(s.withCredentials=!!e.withCredentials),!y&&e.timeout>0&&(u=setTimeout(function(){if(!a){a=!0,s.abort("timeout");var e=Error("XMLHttpRequest timeout");e.code="ETIMEDOUT",r(e)}},e.timeout)),s.setRequestHeader)for(o in p)p.hasOwnProperty(o)&&s.setRequestHeader(o,p[o]);else if(e.headers&&!function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}(e.headers))throw Error("Headers cannot be set on an XDomainRequest object");return"responseType"in e&&(s.responseType=e.responseType),"beforeSend"in e&&"function"==typeof e.beforeSend&&e.beforeSend(s),s.send(f||null),s}h.XMLHttpRequest=t.XMLHttpRequest||function(){},h.XDomainRequest="withCredentials"in new h.XMLHttpRequest?h.XMLHttpRequest:t.XDomainRequest,function(e,t){for(var n=0;e.length>n;n++)t(e[n])}(["get","put","post","patch","head","delete"],function(e){h["delete"===e?"del":e]=function(t,n,r){return(n=p(t,n,r)).method=e.toUpperCase(),y(n)}});var m=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},v=function(){function e(e,t){for(var n=0;t.length>n;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),g=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},b=void 0,w=new(function(){function e(){if(m(this,e),b)return b;b=this}return v(e,[{key:"isFunction",value:function(e){return"function"==typeof e}},{key:"isPrimitive",value:function(e){return"number"==typeof e||"string"==typeof e||"boolean"==typeof e}},{key:"isString",value:function(e){return"string"==typeof e}},{key:"isNumber",value:function(e){return"number"==typeof e}},{key:"isBoolean",value:function(e){return"boolean"==typeof e}},{key:"isEmpty",value:function(e){return void 0===e||null===e}},{key:"isArray",value:function(e){return"array"===Object.prototype.toString.call(e).slice(8).slice(0,-1).toLowerCase()}},{key:"isObject",value:function(e){return"object"===Object.prototype.toString.call(e).slice(8).slice(0,-1).toLowerCase()}},{key:"isJSONSafe",value:function(e){try{return JSON.stringify(e),!0}catch(e){return!1}}},{key:"hashCode",value:function(e){return(e+"").split("").reduce(function(e,t){return(e=(e<<5)-e+t.charCodeAt(0))&e},0)}},{key:"randomString",value:function(e,t){e=e||16,t=t||"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";var n="",r="",i=Math.floor(.25*e),o=e-i,a=void 0;for(a=Math.abs(this.hashCode((new Date).getTime())%t.length);i--;)r+=t.charAt(Math.floor(a%t.length)),a=Math.abs(this.hashCode(a/t.length));for(;o--;)n+=t.charAt(Math.floor(Math.random()*t.length));return n+=r}},{key:"combinations",value:function(e){var t=this;if(!this.isObject(e))return[];var n=Object.keys(e);if(!n.length)return[];var r=[];n=n.sort().reverse();for(var i=function(){var i=n.pop(),o=e[i];o&&!t.isArray(o)&&(o=[o]),o.length&&(r=0===r.length?o.map(function(e){return g({},i,e)}):r.map(function(e){return o.map(function(t){return Object.assign(g({},i,t),e)})}).reduce(function(e,t){return e.concat(t)},[]))};n.length;)i();return r}},{key:"merge",value:function(e,t){var n=this,r=void 0;return!0===e?(r=Array.prototype.slice.call(arguments,2),(null==t||this.isPrimitive(t))&&(t={}),r.forEach(function(e){if(n.isObject(e)||n.isArray(e))for(var r in e)e.hasOwnProperty(r)&&(n.isArray(e[r])?(t[r]=n.result(t[r],"array"),n.merge(!0,t[r],e[r])):n.isObject(e[r])&&e[r].constructor===Object?(t[r]=n.result(t[r],"object"),n.merge(!0,t[r],e[r])):t[r]=e[r])})):(!1===e?r=Array.prototype.slice.call(arguments,2):(t=e,r=Array.prototype.slice.call(arguments,1)),r.forEach(function(e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})),t}},{key:"deepMerge",value:function(){return this.merge.bind(this,!0).apply(this,arguments)}},{key:"result",value:function(e,t,n){return this.isFunction(e)&&(e=e.call(n)),this.isString(t)||(t=""),"array"===(t=t.toLowerCase())?this.isArray(e)?e:[]:"object"===t?this.isObject(e)?e:{}:"number"===t?parseFloat(e):e}}]),e}()),O=function(){function e(t){if(m(this,e),this.amp=t.amp,!this.amp)throw Error("Not the right way to create a session!");this.id=t.id||w.randomString(),this.userId=t.userId||w.randomString(5),this.timeout=t.timeout||1e3,this.ttl=t.ttl,this.index=1,this.created=this.updated=Date.now()}return v(e,[{key:"observe",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=arguments[3];n.timeout=n.timeout||this.timeout,n.url=this.amp.domain+this.amp.apiPath+this.amp.key+"/observe",w.isFunction(arguments[arguments.length-1])&&(r=arguments[arguments.length-1]),this.request({name:e,sessionId:this.id,userId:this.userId,properties:t,index:this.index++,key:this.amp.key},n,function(e,t,n){e&&"EARLY_TERMINATION"===e.message?r&&r(null,n):r&&r(e,n)})}},{key:"decide",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=arguments[3];n.limit=1,n.timeout=n.timeout||this.timeout,n.url=this.amp.domain+this.amp.apiPath+this.amp.key+"/decide";var i=this._formatCandidates(t),o=i.requestSafeCandidates,a=i.allCandidates;return w.isFunction(arguments[arguments.length-1])&&(r=arguments[arguments.length-1]),a.length>50?(r&&r(Error("Candidate length must be less than or equal to 50."),a[0]),a[0]):(this.request({name:e,key:this.amp.key,sessionId:this.id,userId:this.userId,decision:{candidates:o,limit:n.limit},index:this.index++},n,function(e,t,n){var i=a[0];if(e&&"EARLY_TERMINATION"===e.message)r&&r(null,i,n);else if(!e&&n&&n.index){var o=n.indexes.map(function(e){return a[e]});r&&r(null,o[0],n)}else r&&r(e,i,n)}),a[0])}},{key:"_formatCandidates",value:function(e){var t={allCandidates:[],requestSafeCandidates:[]};return e?(w.isArray(e)?(t.allCandidates=e,t.requestSafeCandidates=e.map(function(e){return w.isObject(e)?e:{value:e}})):w.isObject(e)&&(t.allCandidates=w.combinations(e),t.requestSafeCandidates=[e]),t):t}},{key:"request",value:function(e,t,n){var r=this,i=void 0;setTimeout(function(){i||(i=!0,r.updated=Date.now(),n&&n.call(r,Error("EARLY_TERMINATION")))},t.timeout),f({method:"post",url:t.url,body:e,timeout:t.timeout,useXDR:!0,json:!0},function(e,t,o){i||(i=!0,r.updated=Date.now(),n&&n.call(r,e,t,o))})}},{key:"serialize",value:function(){return JSON.stringify({index:this.index,context:this.context,id:this.id,ttl:this.ttl,updated:this.updated,created:this.created,userId:this.userId})}}]),e}();return function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(m(this,e),this.key=t.key,!this.key)throw Error("Project Key Needed!");this.apiPath=t.apiPath||"/api/core/v1/",this.domain=t.domain||"https://amp.ai",this.options=t,this.timeout=t.timeout;var n=this;this.Session=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=Object.assign({},e);return"string"==typeof e?n.Session.deserialize(e):(t.amp=n,t.id=e.id,t.userId=e.userId||n.options.userId,t.timeout=e.timeout||n.timeout||1e3,t.ttl=e.ttl||n.options.sessionTTL||0,new O(t))},this.Session.deserialize=function(e){try{var t=JSON.parse(e);return t.updated&&t.ttl&&Date.now()-t.updated<t.ttl?new O(Object.assign(t,{amp:n})):new n.Session}catch(e){return new n.Session}}}}();
